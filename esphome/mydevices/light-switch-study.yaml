#########################################################################
#
# Device configuration for Athom Wall Switch - 2 Gang v1, with neutral (ESP8285)
# 
# v1.0.0 - 22nd May 2025
#
##########################################################################
# VERSION UPATES:
#
# v0.1.0 - Upate to use Roving Ronin base configurations
#
substitutions:
  # Default name
  name: "switch-study"
  # Default friendly name
  friendly_name: "Switch - Study & Dining"
  # Description as appears in ESPHome & top of webserver page
  device_description: "Athom - Light Switch for Study & Dining (Master)"
  # Project Name
  project_name: "Athom Technology.Light Switch 2 Gang"
  # Projection version denotes the release version of the yaml file, allowing checking of deployed vs latest version
  project_version: "v1.4.0"
  # Allows ESP device to be automatically lined to an 'Area' in Home Assistant. Typically used for areas such as 'Lounge Room', 'Kitchen' etc  
  location: "Study"
  # The phase in the home power supply, upon which this device is utilsed. A, B or C.  (myHome GPO 1 = Phase A, GPO 2 = Phase B, GPO 3 = Phase C)  
  power_phase: "A"
  # The circuit breaker / RCBO that the load is attached to.  
  power_rcbo: "Lights"
  # Restore the relay (GPO switch) upon reboot to state:
  light1_restore_mode: RESTORE_DEFAULT_OFF
  light2_restore_mode: RESTORE_DEFAULT_OFF
  # Button Label Names:
  button1_assignment: "Study Lights"
  button2_assignment: "Dining Lights"
  # Backlight LED Name:
  backlight1_assignment: "Study"
  backlight2_assignment: "Dining"

  # Define logging level: NONE, ERROR, WARN, INFO, DEBUG (Default), VERBOSE, VERY_VERBOSE
  log_level: "ERROR"
  
########################## End of Substitutions #########################
#
# Defines the type of ESP chip used on the device
#

esp8266:
  board: esp8285
  restore_from_flash: true

logger:
  baud_rate: 115200

preferences:
   # Enable to allow storing of 'Read Total' between reboots and flashing.
  flash_write_interval: 30min

#########################################################################
#
# Remote Packages to be utilised
#

dashboard_import:
  package_import_url: github://roving-ronin/myhomeassistant/esphome/mydevices/light-switch-study.yaml@main
  import_full_config: false


packages:
  base-config:
    url: https://github.com/roving-ronin/myhomeassistant
    ref: main
    files: [esphome/common/base-configuration.yaml]
    refresh: 1h
    
  network_config:
    url: https://github.com/roving-ronin/myhomeassistant
    ref: main
    files: [esphome/common/network-wifi.yaml]
    refresh: 1h

  webserver_groups:
    url: https://github.com/roving-ronin/myhomeassistant
    ref: main
    files: [esphome/common/webserver-groups.yaml]
    refresh: 5s

#####################################################################
#
# External Components
#

# Track the runtime of the light (last used and lifetime)
external_components:
#  - source:
#      type: git
#      url: https://github.com/roving-ronin/myhomeassistant/
#      ref: main
#    refresh: 1h
#    components: [ usage_tracker ]

  - source:
      type: git
      url: https://github.com/Cossid/TasmotaDeviceGroupsForESPHome
      ref: main
    refresh: 1h
    components: [ device_groups ]



#####################################################################
#
# Tasmota Device Groups for ESPHome
#
device_groups:
  - group_name: "dining-lights"   # Tasmota device group name
    send_mask: 0xFFFFFFFF         # Optional, defaults to 0xFFFFFFFF (send everything).  Can be integer or hex
    receive_mask: 0xFFFFFFFF      # Optional, defaults to 0xFFFFFFFF (receive everything).  Can be integer or hex
    lights:
      - light2                     # ESPHome entity id


#####################################################################

web_server:
  include_internal: false

#########################################################################
#
#
#

esphome:
  # Define areas (optional), as opposed to 'area'
  areas:
    - id: dining_room_area
      name: "Dining Room"
    - id: study_area
      name: "Study"
  # Define devices, to be used in 'Areas'
  devices:
    - id: dining_room_device
      name: "Dining Room Lights"
      area_id: dining_room_area
    - id: study_device
      name: "Study Lights"
      area_id: study_area
  # this board has 2mb flash, but esphome assumes 1mb for the 8285 board id
  platformio_options:
    board_upload.flash_size: 2MB
    board_upload.maximum_size: 2097152
    board_build.ldscript: eagle.flash.2m.ld
  # Actions to perform upon device booting
  on_boot:
    - priority: 600
      then:
        - select.set_index:
            id: power_mode
            index: !lambda |-
                    return id(restore_mode)-1;
        - lambda: |-
              switch(id(restore_mode))
              {
              case 1:{
                      id(light1).turn_off();
                      id(light2).turn_off();
                      break;
                            }
              case 2:{
                      id(light1).turn_on();
                      id(light2).turn_on();
                      break;
                            }
              default:{
                      break;
                            }
              }


#########################################################################
#
# Globals to save values to NVS RAM
#

globals:
  - id: restore_mode
    type: int
    restore_value: yes
    initial_value: "3"


#########################################################################
#
# Select action to set default power on state
#

select:
  - platform: template
    name: "Power On State"
    id: "power_mode"
    icon: 'mdi:electric-switch'
    optimistic: true
    options:
      - Always Off
      - Always On
      - Restore Power Off State
    on_value:
      then:
        - lambda: |-
            id(restore_mode)=i+1;
    entity_category: config

#########################################################################
#
# Binary Sensors
#

binary_sensor:

    # Touch Button
  - platform: gpio
    pin:
      inverted: true
      number: GPIO3
      mode:
        input: true
        pullup: true
    name: ${button1_assignment}
    id: button1
    icon: 'mdi:gesture-tap-button'
    on_multi_click:
      - timing:
          - ON for at most 0.5s
          - OFF for at least 0.2s
        then:
          - light.toggle: light1
      - timing:
          - ON for at least 4s
        then:
          - button.press: Reset
    internal: true
    disabled_by_default: true


  - platform: gpio
    pin:
      inverted: true
      number: GPIO5
      mode:
        input: true
        pullup: true
    name: ${button2_assignment}
    id: button2
    icon: 'mdi:gesture-tap-button'
    on_click:
      max_length: 0.5s
      then:
        - light.toggle: light2
    internal: true
    disabled_by_default: true
    
    # Binary sensor that tracks of the Light (id: downlight) is ON or OFF.
    # This is used by the usage_tracker as its source sensor.
#  - platform: template
#    name: "Light 1 - State"
#    id: light1_state
#    icon: 'mdi:state-machine'
#    lambda: |-
#      return id(light1).current_values.is_on();
#    internal: true
#    disabled_by_default: true
    

    # Binary sensor that tracks of the Light (id: downlight) is ON or OFF.
    # This is used by the usage_tracker as its source sensor.
#  - platform: template
#    name: "Light 2 - State"
#    id: light2_state
#    icon: 'mdi:state-machine'
#    lambda: |-
#      return id(light2).current_values.is_on();
#    internal: true
#    disabled_by_default: true
    

##########################################################################
#
# Relays
#

output:
  # Relay
  - platform: gpio
    pin: GPIO13
    id: relay1

  - platform: gpio
    pin: GPIO4
    id: relay2

  # Button LED (1.0 = Blue / 0.0 = Red)
  - platform: esp8266_pwm
    pin: GPIO14                        # v2 = 16
    inverted: true
    id: button_led1

  - platform: esp8266_pwm
    pin: GPIO1
    inverted: true
    id: button_led2


##########################################################################
#
# Lights
#

light:

  # Relays
  - platform: binary
    name: ${button1_assignment}
    id: light1
    device_id: study_device
    icon: 'mdi:lightbulb'
    output: relay1
    restore_mode: ${light1_restore_mode}
    on_turn_on:
      - light.turn_on: led1
    on_turn_off:
      - light.turn_off: led1
    web_server:
      sorting_group_id: group_light_switches
      sorting_weight: 1

  - platform: binary
    name: ${button2_assignment}
    id: light2
    device_id: dining_room_device
    icon: 'mdi:lightbulb'
    output: relay2
    restore_mode: ${light2_restore_mode}
    on_turn_on:
      - light.turn_on: led2
    on_turn_off:
      - light.turn_off: led2
    web_server:
      sorting_group_id: group_light_switches
      sorting_weight: 2
      

  # Button LEDs
  - platform: monochromatic
    name: "Backlight - ${backlight1_assignment}"
    icon: 'mdi:led-on'
    disabled_by_default: true
    id: led1
    device_id: study_device
    output: button_led1
    default_transition_length: 500ms
    web_server:
      sorting_group_id: group_light_switches
      sorting_weight: 3


  - platform: monochromatic
    name: "Backlight - ${backlight2_assignment}"
    icon: 'mdi:led-on'
    disabled_by_default: true
    id: led2
    device_id: dining_room_device
    output: button_led2
    default_transition_length: 500ms
    web_server:
      sorting_group_id: group_light_switches
      sorting_weight: 4

#########################################################################
#
# Define the sensors that publish the Last Use & Lifetime Use duration of the LED.
# See: https://github.com/Roving-Ronin/myHomeAssistant/tree/main/components/usage_tracker
#

#sensor:
    # Light 1
#  - platform: "usage_tracker"
#    id: light1_usage_tracker
#    on_off_sensor: light1_state
      
#    last_use:
#      name: "Light 1 - Duration Last Use"
#      id: light1_duration_last_use
#      unit_of_measurement: h
#      accuracy_decimals: 3
#      filters:
#        - lambda: |-
#            return x / 3600.0;
#        - delta: 0.001
#      web_server:
#        sorting_group_id: group_light_usage
#        sorting_weight: 1

#    lifetime_use:
#      name: "Light 1 - Duration Lifetime Use"
#      id: light1_duration_lifetime_use
#      unit_of_measurement: h
#      accuracy_decimals: 3
#      filters:
#        - lambda: |-
#            return x / 3600.0;
#        - delta: 0.001
#      web_server:
#        sorting_group_id: group_light_usage
#        sorting_weight: 2

##########################

    # Light 2
#  - platform: "usage_tracker"
#    id: light2_usage_tracker
#    on_off_sensor: light2_state
      
#    last_use:
#      name: "Light 2 - Duration Last Use"
#      id: light2_duration_last_use
#      unit_of_measurement: h
#      accuracy_decimals: 3
#      filters:
#        - lambda: |-
#            return x / 3600.0;
#        - delta: 0.001
#      web_server:
#        sorting_group_id: group_light_usage
#        sorting_weight: 3

#    lifetime_use:
#      name: "Light 2 - Duration Lifetime Use"
#      id: light2_duration_lifetime_use
#      unit_of_measurement: h
#      accuracy_decimals: 3
#      filters:
#        - lambda: |-
#            return x / 3600.0;
#        - delta: 0.001
#      web_server:
#        sorting_group_id: group_light_usage
#        sorting_weight: 4


##########################################################################
